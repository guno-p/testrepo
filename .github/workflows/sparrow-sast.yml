name: Sparrow SAST

on:
  push:
    branches: ["main"]

jobs:
  sast:
    runs-on: [self-hosted, Windows, X64]

    steps:
      - uses: actions/checkout@v4

      - name: Run Sparrow SAST
        shell: pwsh
        run: |
          $ws = ([string]$env:GITHUB_WORKSPACE).Trim()

          # password.txt (레포에 저장 금지)
          Set-Content -Path "$ws\password.txt" -Value "${{ secrets.SPARROW_PASSWORD }}" -NoNewline

          # analysis.json (분석 대상 = 머지된 레포 전체 루트)
          $analysis = @{
            type    = "full"
            profile = "${{ secrets.SPARROW_PROFILE }}"
            targets = @(
              @{
                type       = "file"
                path       = @($ws)
                extensions = @("*")
                basePath   = $ws
              }
            )
          }
          $analysis | ConvertTo-Json -Depth 20 | Set-Content -Path "$ws\analysis.json" -Encoding UTF8

          # CLI 실행
          $cli = "C:\workspace\sparrow-enterprise-client-windows-2512.2\sparrow-cli.cmd"
          & $cli create analysis `
            -k "${{ secrets.SPARROW_PROJECT_KEY }}" `
            -f "$ws\analysis.json" `
            -s "${{ secrets.SPARROW_SERVER_URL }}" `
            -u "${{ secrets.SPARROW_USER }}" `
            -p "$ws\password.txt"
