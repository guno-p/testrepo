name: Sparrow SAST

on:
  push:
    branches: ["main"]

jobs:
  sast:
    runs-on: [self-hosted, Windows, X64]

    steps:
      - uses: actions/checkout@v4

      - name: Run Sparrow SAST
        shell: powershell
        run: |
          $ws = ([string]$env:GITHUB_WORKSPACE).Trim()

          # password.txt
          Set-Content -Path "$ws\password.txt" -Value "${{ secrets.SPARROW_PASSWORD }}" -NoNewline

          # Base64로부터 한글 프로파일 복원
          $profile = [Text.Encoding]::UTF8.GetString([Convert]::FromBase64String("${{ secrets.SPARROW_PROFILE_B64 }}"))

          $analysis = @{
            type    = "full"
            profile = $profile
            targets = @(
              @{
                type       = "file"
                path       = @($ws)
                extensions = @("*")
                basePath   = $ws
              }
            )
          }

          $json = $analysis | ConvertTo-Json -Depth 20
          # UTF-8 (BOM 없음)으로 저장
          [System.IO.File]::WriteAllText("$ws\analysis.json", $json, (New-Object System.Text.UTF8Encoding($false)))

          $cli = "C:\workspace\sparrow-enterprise-client-windows-2512.2\sparrow-cli.cmd"
          & $cli create analysis `
            -k "${{ secrets.SPARROW_PROJECT_KEY }}" `
            -f "$ws\analysis.json" `
            -s "${{ secrets.SPARROW_SERVER_URL }}" `
            -u "${{ secrets.SPARROW_USER }}" `
            -p "$ws\password.txt"
