name: Sparrow SAST

on:
  push:
    branches: ["main"]

jobs:
  sast:
    runs-on: [self-hosted, Windows, X64]

    steps:
      - uses: actions/checkout@v4

      - name: Run Sparrow SAST
        shell: pwsh
        run: |
          $ws = $env:GITHUB_WORKSPACE.Trim()

          # password.txt
          Set-Content -Path "$ws\password.txt" -Value "${{ secrets.SPARROW_PASSWORD }}" -NoNewline

          # profile (한글 깨짐 방지: pwsh + Trim)
          $profile = "${{ secrets.SPARROW_PROFILE }}"

          # analysis.json 생성
          $analysis = @{
            type    = "full"
            profile = $profile
            targets = @(
              @{
                type       = "file"
                path       = @($ws)
                extensions = @("*")
                basePath   = $ws
              }
            )
          }

          $json = $analysis | ConvertTo-Json -Depth 20

          # UTF-8 (BOM 없음)으로 저장
          [System.IO.File]::WriteAllText("$ws\analysis.json", $json, (New-Object System.Text.UTF8Encoding($false)))

          # CLI 실행
          $cli = "C:\workspace\sparrow-enterprise-client-windows-2512.2\sparrow-cli.cmd"
          & $cli create analysis `
            -k "${{ secrets.SPARROW_PROJECT_KEY }}" `
            -f "$ws\analysis.json" `
            -s "${{ secrets.SPARROW_SERVER_URL }}" `
            -u "${{ secrets.SPARROW_USER }}" `
            -p "$ws\password.txt"
